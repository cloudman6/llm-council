#!/usr/bin/env python3
"""
é›†æˆæµ‹è¯•ï¼šä¼˜åŒ–åçš„chairmanè¯„ä¼°å’Œæ”¶æ•›é˜¶æ®µ
"""

import asyncio
import json
from backend.council import build_convergent_prompt, validate_and_parse_json

def test_optimized_integration():
    """æµ‹è¯•ä¼˜åŒ–åçš„å¤šè½®è®¨è®ºé›†æˆæ•ˆæœ"""

    print("ğŸš€ é›†æˆæµ‹è¯•ï¼šä¼˜åŒ–åçš„å¤šè½®è®¨è®ºç³»ç»Ÿ")
    print("="*80)

    # æ¨¡æ‹Ÿå®Œæ•´çš„è®¨è®ºæµç¨‹
    user_query = "è¿œç¨‹åŒ»ç–—åœ¨æ…¢æ€§ç—…ç®¡ç†ä¸­çš„æœ‰æ•ˆæ€§å’ŒæŒ‘æˆ˜æ˜¯ä»€ä¹ˆï¼Ÿ"

    # ç¬¬ä¸€è½®ï¼šå‘æ•£é˜¶æ®µçš„ç»“æœ
    round1_results = [
        {
            "model": "gpt-4",
            "response": """```json
{
  "summary": "è¿œç¨‹åŒ»ç–—åœ¨æ…¢æ€§ç—…ç®¡ç†ä¸­å…·æœ‰æé«˜å¯åŠæ€§å’Œç›‘æµ‹èƒ½åŠ›çš„æ½œåŠ›ï¼Œä½†é¢ä¸´æŠ€æœ¯å’Œäººæ–‡æŒ‘æˆ˜",
  "viewpoints": [
    "è¿œç¨‹ç›‘æµ‹æŠ€æœ¯å¯ä»¥å®æ—¶è·Ÿè¸ªæ…¢æ€§ç—…æ‚£è€…çš„å¥åº·æŒ‡æ ‡",
    "æ•°å­—é¸¿æ²Ÿå’ŒæŠ€æœ¯æ¥å—åº¦æ˜¯ä¸»è¦éšœç¢",
    "åŒ»æ‚£å…³ç³»è´¨é‡å¯èƒ½å› ç¼ºä¹é¢å¯¹é¢äº¤æµè€Œå—å½±å“",
    "æ•°æ®å®‰å…¨å’Œéšç§ä¿æŠ¤éœ€è¦ç‰¹åˆ«å…³æ³¨"
  ],
  "final_answer_candidate": "è¿œç¨‹åŒ»ç–—åœ¨æ…¢æ€§ç—…ç®¡ç†ä¸­å‰æ™¯å¹¿é˜”ï¼Œä½†éœ€è¦è§£å†³æŠ€æœ¯å¯åŠæ€§ã€åŒ»æ‚£å…³ç³»å’Œæ•°æ®å®‰å…¨ç­‰å…³é”®æŒ‘æˆ˜ã€‚"
}```
            """
        },
        {
            "model": "claude-3-sonnet",
            "response": """```json
{
  "summary": "è¿œç¨‹åŒ»ç–—é€šè¿‡æŠ€æœ¯åˆ›æ–°æ”¹å–„æ…¢æ€§ç—…ç®¡ç†ï¼Œä½†éœ€è¦æ”¿ç­–æ”¯æŒå’Œäººæ€§åŒ–è®¾è®¡",
  "viewpoints": [
    "å¯ç©¿æˆ´è®¾å¤‡å’Œç§»åŠ¨åº”ç”¨ä½¿æ‚£è€…è‡ªæˆ‘ç®¡ç†æ›´åŠ ä¾¿æ·",
    "åŒ»ä¿æŠ¥é”€æ”¿ç­–ä¸æ˜ç¡®é™åˆ¶äº†è¿œç¨‹åŒ»ç–—çš„æ™®åŠ",
    "è€å¹´äººå’Œä½æ”¶å…¥ç¾¤ä½“çš„æŠ€æœ¯ä½¿ç”¨é—¨æ§›è¾ƒé«˜",
    "éœ€è¦é‡æ–°è®¾è®¡åŒ»ç–—æœåŠ¡æµç¨‹ä»¥é€‚åº”è¿œç¨‹æ¨¡å¼"
  ],
  "final_answer_candidate": "è¿œç¨‹åŒ»ç–—åœ¨æ…¢æ€§ç—…ç®¡ç†ä¸­å…·æœ‰æ˜¾è‘—ä¼˜åŠ¿ï¼Œä½†éœ€è¦æ”¿ç­–æ”¯æŒã€æŠ€æœ¯ç®€åŒ–å’Œæµç¨‹ä¼˜åŒ–ã€‚"
}```
            """
        }
    ]

    # ç¬¬ä¸€è½®chairmanè¯„ä¼°
    round1_chairman = {
        "convergence_score": 0.6,
        "is_converged": False,
        "consensus_points": [
            "è¿œç¨‹åŒ»ç–—èƒ½å¤Ÿæé«˜æ…¢æ€§ç—…ç®¡ç†çš„å¯åŠæ€§å’Œä¾¿åˆ©æ€§",
            "æŠ€æœ¯å’Œè®¾å¤‡å‘å±•æ˜¯æ¨åŠ¨è¿œç¨‹åŒ»ç–—çš„å…³é”®å› ç´ ",
            "å­˜åœ¨æŠ€æœ¯å¯åŠæ€§å’ŒåŒ»æ‚£å…³ç³»æ–¹é¢çš„æŒ‘æˆ˜"
        ],
        "conflict_points": [
            "æŠ€æœ¯æ¥å—åº¦å’Œæ•°å­—é¸¿æ²Ÿçš„ç¨‹åº¦å’Œè§£å†³æ–¹æ¡ˆå­˜åœ¨åˆ†æ­§",
            "å¯¹åŒ»æ‚£å…³ç³»è´¨é‡å½±å“çš„çœ‹æ³•ä¸åŒ",
            "æ”¿ç­–æ”¯æŒå’Œå•†ä¸šåŒ–è·¯å¾„çš„ä¼˜å…ˆçº§æœ‰å·®å¼‚"
        ],
        "explanation": "ç¬¬ä¸€è½®è®¨è®ºè¯†åˆ«äº†è¿œç¨‹åŒ»ç–—çš„ä¸»è¦ä¼˜åŠ¿å’ŒæŒ‘æˆ˜ï¼Œä½†åœ¨æŠ€æœ¯æ™®åŠéšœç¢ã€åŒ»æ‚£å…³ç³»å˜åŒ–å’Œæ”¿ç­–æ”¯æŒä¼˜å…ˆçº§æ–¹é¢å­˜åœ¨åˆ†æ­§ï¼Œéœ€è¦è¿›ä¸€æ­¥æ·±å…¥è®¨è®ºã€‚",
        "questions_for_next_round": [
            "å…·ä½“å“ªäº›æ…¢æ€§ç—…æœ€é€‚åˆè¿œç¨‹åŒ»ç–—ç®¡ç†ï¼Ÿ",
            "å¦‚ä½•æœ‰æ•ˆè§£å†³è€å¹´äººå’Œä½æ”¶å…¥ç¾¤ä½“çš„æŠ€æœ¯å¯åŠæ€§é—®é¢˜ï¼Ÿ",
            "è¿œç¨‹åŒ»ç–—å¦‚ä½•é‡æ–°è®¾è®¡åŒ»æ‚£å…³ç³»ä»¥ä¿æŒæœåŠ¡è´¨é‡ï¼Ÿ"
        ],
        "final_integrated_conclusion": ""
    }

    print("ğŸ“‹ ç¬¬ä¸€è½®è®¨è®ºæ€»ç»“")
    print("="*40)
    print(f"æ”¶æ•›è¯„åˆ†: {round1_chairman['convergence_score']}/1.0")
    print(f"å…±è¯†ç‚¹: {len(round1_chairman['consensus_points'])} ä¸ª")
    print(f"å†²çªç‚¹: {len(round1_chairman['conflict_points'])} ä¸ª")
    print(f"é—®é¢˜: {len(round1_chairman['questions_for_next_round'])} ä¸ª")

    print("\nğŸ”„ ç¬¬äºŒè½®ï¼šæ”¶æ•›é˜¶æ®µï¼ˆä¼˜åŒ–åçš„Promptï¼‰")
    print("="*40)

    # æ„å»ºä¼˜åŒ–åçš„æ”¶æ•›é˜¶æ®µprompt
    convergent_prompt = build_convergent_prompt(
        user_query=user_query,
        consensus_points=round1_chairman["consensus_points"],
        conflict_points=round1_chairman["conflict_points"],
        questions=round1_chairman["questions_for_next_round"]
    )

    print(f"ğŸ“ Prompté•¿åº¦: {len(convergent_prompt)} å­—ç¬¦")
    print("ğŸ¯ ä¼˜åŒ–è¦ç‚¹éªŒè¯:")

    # éªŒè¯å…³é”®ä¼˜åŒ–è¦ç‚¹
    optimization_features = [
        "æ·±åº¦åˆ†æä¸Šä¸€è½®è®¨è®ºç»“æœ",
        "å…±è¯†ç‚¹æ·±åº¦åˆ†æ",
        "å†²çªç‚¹æ·±åº¦åˆ†æ",
        "åŒæ„ç¨‹åº¦",
        "è¡¥å……è¯´æ˜",
        "ç«‹åœºé€‰æ‹©",
        "è°ƒå’Œæ–¹æ¡ˆ",
        "consensus_analysis",
        "conflict_analysis",
        "æ•´åˆè¦æ±‚"
    ]

    for feature in optimization_features:
        if feature in convergent_prompt:
            print(f"  âœ… {feature}")
        else:
            print(f"  âŒ {feature}")

    # æ¨¡æ‹Ÿä¼˜åŒ–åçš„ç¬¬äºŒè½®å“åº”
    optimized_round2_response = """```json
{
  "summary": "åŸºäºå¯¹ç¬¬ä¸€è½®å…±è¯†ç‚¹å’Œå†²çªç‚¹çš„æ·±åº¦åˆ†æï¼Œæˆ‘è®¤ä¸ºç³–å°¿ç—…ã€é«˜è¡€å‹å’Œå¿ƒè¡€ç®¡ç–¾ç—…æœ€é€‚ç”¨è¿œç¨‹åŒ»ç–—ç®¡ç†ï¼Œéœ€è¦é€šè¿‡åˆ†å±‚æ”¯æŒä½“ç³»å’ŒåŒ»æ‚£å…³ç³»é‡å¡‘æ¥è§£å†³æŠ€æœ¯å¯åŠæ€§é—®é¢˜",
  "viewpoints": [
    "æ…¢æ€§ç—…é€‰æ‹©åº”åŸºäºç›‘æµ‹é¢‘ç‡ç¨³å®šæ€§å’ŒæŠ€æœ¯æˆç†Ÿåº¦",
    "åˆ†å±‚æŠ€æœ¯æ”¯æŒä½“ç³»èƒ½å¤Ÿæœ‰æ•ˆè§£å†³æ•°å­—é¸¿æ²Ÿé—®é¢˜",
    "æ··åˆå¼åŒ»æ‚£å…³ç³»æ¨¡å¼æ˜¯ä¿æŒæœåŠ¡è´¨é‡çš„æœ€ä½³æ–¹æ¡ˆ"
  ],
  "consensus_analysis": [
    {
      "consensus_point": "è¿œç¨‹åŒ»ç–—èƒ½å¤Ÿæé«˜æ…¢æ€§ç—…ç®¡ç†çš„å¯åŠæ€§å’Œä¾¿åˆ©æ€§",
      "agreement_level": "å®Œå…¨åŒæ„",
      "supplement": "WHOç ”ç©¶æ˜¾ç¤ºï¼Œè¿œç¨‹ç®¡ç†å¯ä½¿ç³–å°¿ç—…æ‚£è€…è¡€ç³–æ§åˆ¶æ”¹å–„20%ï¼Œé«˜è¡€å‹æ‚£è€…è¡€å‹è¾¾æ ‡ç‡æé«˜25%",
      "conditions": "ä¸»è¦é€‚ç”¨äºéœ€è¦å®šæœŸç›‘æµ‹çš„æ…¢æ€§ç—…ï¼Œæ€¥æ€§æœŸå’Œç²¾ç¥ç–¾ç—…ä»éœ€ä¼ ç»Ÿè¯Šç–—",
      "deeper_insight": "å¯åŠæ€§ä¸ä»…æŒ‡åœ°ç†ä¾¿åˆ©ï¼Œè¿˜åŒ…æ‹¬æ—¶é—´çµæ´»æ€§ã€æˆæœ¬é™ä½å’Œå¿ƒç†èˆ’é€‚åº¦æå‡"
    },
    {
      "consensus_point": "æŠ€æœ¯å’Œè®¾å¤‡å‘å±•æ˜¯æ¨åŠ¨è¿œç¨‹åŒ»ç–—çš„å…³é”®å› ç´ ",
      "agreement_level": "å®Œå…¨åŒæ„",
      "supplement": "FDAå·²æ‰¹å‡†600å¤šç§åŒ»ç–—çº§å¯ç©¿æˆ´è®¾å¤‡ï¼Œ5Gç½‘ç»œå»¶è¿Ÿ<10mså¯æ”¯æŒå®æ—¶è¯Šç–—",
      "conditions": "éœ€è¦å»ºç«‹ç»Ÿä¸€çš„æ•°æ®æ ‡å‡†å’Œè®¾å¤‡è®¤è¯ä½“ç³»ï¼Œé¿å…æŠ€æœ¯ç¢ç‰‡åŒ–",
      "deeper_insight": "æŠ€æœ¯å‘å±•ä¸ä»…æŒ‡ç¡¬ä»¶ï¼Œè¿˜åŒ…æ‹¬AIç®—æ³•ã€æ•°æ®åˆ†æå’Œç”¨æˆ·ä½“éªŒè®¾è®¡"
    },
    {
      "consensus_point": "å­˜åœ¨æŠ€æœ¯å¯åŠæ€§å’ŒåŒ»æ‚£å…³ç³»æ–¹é¢çš„æŒ‘æˆ˜",
      "agreement_level": "éƒ¨åˆ†åŒæ„",
      "supplement": "æŠ€æœ¯å¯åŠæ€§é—®é¢˜å¯é€šè¿‡ç¤¾åŒºæ•°å­—åŒ–æœåŠ¡ç«™è§£å†³ï¼ŒåŒ»æ‚£å…³ç³»éœ€è¦æ–°çš„æœåŠ¡æ¨¡å¼",
      "conditions": "åœ¨åŒ»ç–—èµ„æºä¸°å¯Œåœ°åŒºï¼ŒåŒ»æ‚£å…³ç³»è´¨é‡å¯èƒ½æš‚æ—¶ä¸‹é™ï¼Œä½†æ€»ä½“æ•ˆç‡å’Œè¦†ç›–é¢æå‡",
      "deeper_insight": "æŒ‘æˆ˜æœ¬è´¨æ˜¯æœåŠ¡æ¨¡å¼è½¬å‹ï¼ŒæŠ€æœ¯æ˜¯å‚¬åŒ–å‰‚è€Œéæ ¹æœ¬éšœç¢"
    }
  ],
  "conflict_analysis": [
    {
      "conflict_point": "æŠ€æœ¯æ¥å—åº¦å’Œæ•°å­—é¸¿æ²Ÿçš„ç¨‹åº¦å’Œè§£å†³æ–¹æ¡ˆå­˜åœ¨åˆ†æ­§",
      "your_position": "æ•°å­—é¸¿æ²Ÿæ˜¯ç³»ç»Ÿæ€§é—®é¢˜ï¼Œéœ€è¦å¤šå±‚æ¬¡è§£å†³æ–¹æ¡ˆ",
      "reconciliation_approach": "å»ºç«‹ä¸‰çº§æ”¯æŒä½“ç³»ï¼šç¤¾åŒºæ•°å­—åŒ–æœåŠ¡ç«™+å®¶åº­æŠ€æœ¯é¡¾é—®+ç®€åŒ–ç•Œé¢è®¾è®¡",
      "root_cause": "å¹´é¾„ã€æ”¶å…¥ã€æ•™è‚²æ°´å¹³å’Œåœ°åŸŸå·®å¼‚çš„ç»¼åˆå½±å“",
      "impact_assessment": "å…³é”®å½±å“ï¼Œä¸è§£å†³ä¼šé™åˆ¶è¿œç¨‹åŒ»ç–—çš„ç¤¾ä¼šä»·å€¼"
    },
    {
      "conflict_point": "å¯¹åŒ»æ‚£å…³ç³»è´¨é‡å½±å“çš„çœ‹æ³•ä¸åŒ",
      "your_position": "åŒ»æ‚£å…³ç³»éœ€è¦è¿›åŒ–è€Œéé€€åŒ–",
      "reconciliation_approach": "é‡‡ç”¨'æŠ€æœ¯å¢å¼ºçš„äººæ–‡å…³æ€€'æ¨¡å¼ï¼šè¿œç¨‹ç›‘æµ‹+å®šæœŸé¢å¯¹é¢+æƒ…æ„Ÿæ”¯æŒæœåŠ¡",
      "root_cause": "å¯¹åŒ»ç–—è´¨é‡å®šä¹‰çš„ä¸åŒç†è§£ï¼šæŠ€æœ¯æ•ˆç‡vsäººæ€§åŒ–å…³æ€€",
      "impact_assessment": "ä¸­ç­‰å½±å“ï¼Œé€šè¿‡æ­£ç¡®è®¾è®¡å¯ä»¥è½¬åŒ–ä¸ºä¼˜åŠ¿"
    }
  ],
  "conflicts": [
    "ç›¸æ¯”å…¶ä»–æ¨¡å‹æ›´å¼ºè°ƒç³»ç»Ÿæ€§è§£å†³æ–¹æ¡ˆè€ŒéæŠ€æœ¯æ‰‹æ®µ",
    "è®¤ä¸ºåŒ»æ‚£å…³ç³»è½¬å‹éœ€è¦åˆ¶åº¦æ”¯æŒè€Œéä»…é æŠ€æœ¯æ”¹è¿›"
  ],
  "suggestions": [
    "å»ºç«‹å›½å®¶æ…¢æ€§ç—…è¿œç¨‹åŒ»ç–—æ ‡å‡†åŒ–æŒ‡å—",
    "å¼€å‘é€‚è€åŒ–å’Œä½æ•™è‚²æ°´å¹³çš„ä¸“ç”¨ç•Œé¢",
    "åˆ›å»ºè¿œç¨‹åŒ»ç–—æœåŠ¡è´¨é‡è¯„ä»·ä½“ç³»",
    "æ¨è¿›åŒ»ä¿æ”¿ç­–æ”¹é©æ”¯æŒè¿œç¨‹åŒ»ç–—æœåŠ¡"
  ],
  "final_answer_candidate": ""
}````

    print("\nğŸ­ æ¨¡æ‹Ÿä¼˜åŒ–åçš„ç¬¬äºŒè½®å“åº”")
    print("="*40)

    # éªŒè¯å’Œè§£æå“åº”
    parsed_response = validate_and_parse_json(optimized_round2_response, "test-model")

    if parsed_response:
        print("âœ… JSONæ ¼å¼éªŒè¯æˆåŠŸ")
        print(f"ğŸ“Š å“åº”å­—æ®µéªŒè¯:")

        required_fields = ['summary', 'viewpoints', 'final_answer_candidate']
        new_fields = ['consensus_analysis', 'conflict_analysis']

        for field in required_fields:
            if field in parsed_response:
                print(f"  âœ… {field}: {type(parsed_response[field])}")
            else:
                print(f"  âŒ ç¼ºå¤±: {field}")

        for field in new_fields:
            if field in parsed_response:
                print(f"  ğŸ†• {field}: {type(parsed_response[field])} (æ–°å¢åˆ†æå­—æ®µ)")
                if parsed_response[field]:
                    print(f"     æ•°é‡: {len(parsed_response[field])} ä¸ªåˆ†æé¡¹ç›®")
            else:
                print(f"  âŒ ç¼ºå¤±æ–°å¢å­—æ®µ: {field}")

        # å±•ç¤ºæ·±åº¦åˆ†æç¤ºä¾‹
        if "consensus_analysis" in parsed_response and parsed_response["consensus_analysis"]:
            print("\nğŸ”¹ å…±è¯†ç‚¹æ·±åº¦åˆ†æç¤ºä¾‹:")
            example = parsed_response["consensus_analysis"][0]
            print(f"   å…±è¯†ç‚¹: {example.get('consensus_point', 'N/A')}")
            print(f"   åŒæ„ç¨‹åº¦: {example.get('agreement_level', 'N/A')}")
            print(f"   è¡¥å……è¯´æ˜: {example.get('supplement', 'N/A')[:80]}...")
            print(f"   æˆç«‹æ¡ä»¶: {example.get('conditions', 'N/A')[:80]}...")

        if "conflict_analysis" in parsed_response and parsed_response["conflict_analysis"]:
            print("\nâš¡ å†²çªç‚¹æ·±åº¦åˆ†æç¤ºä¾‹:")
            example = parsed_response["conflict_analysis"][0]
            print(f"   å†²çªç‚¹: {example.get('conflict_point', 'N/A')}")
            print(f"   ä½ çš„ç«‹åœº: {example.get('your_position', 'N/A')[:80]}...")
            print(f"   è°ƒå’Œæ–¹æ¡ˆ: {example.get('reconciliation_approach', 'N/A')[:80]}...")
            print(f"   å½±å“è¯„ä¼°: {example.get('impact_assessment', 'N/A')}")

    else:
        print("âŒ JSONæ ¼å¼éªŒè¯å¤±è´¥")

    print("\nğŸ“ˆ ä¼˜åŒ–æ•ˆæœå¯¹æ¯”")
    print("="*40)
    print("ğŸ”´ ä¼˜åŒ–å‰ï¼ˆç¬¬ä¸€è½®ï¼‰:")
    print(f"   å…±è¯†ç‚¹åˆ†æ: æ— ç»“æ„åŒ–åˆ†æ")
    print(f"   å†²çªç‚¹åˆ†æ: æ— ç»“æ„åŒ–åˆ†æ")
    print(f"   æ·±åº¦åˆ†æ: ç¼ºå¤±ç³»ç»Ÿæ€§è¦æ±‚")
    print(f"   æ•´åˆèƒ½åŠ›: ç®€å•è§‚ç‚¹ç½—åˆ—")

    print("\nğŸŸ¢ ä¼˜åŒ–åï¼ˆç¬¬äºŒè½®ï¼‰:")
    print(f"   å…±è¯†ç‚¹åˆ†æ: {len(parsed_response.get('consensus_analysis', []))} ä¸ªæ·±åº¦åˆ†æ")
    print(f"   å†²çªç‚¹åˆ†æ: {len(parsed_response.get('conflict_analysis', []))} ä¸ªæ·±åº¦åˆ†æ")
    print(f"   æ·±åº¦åˆ†æ: 4ç»´åº¦ç»“æ„åŒ–è¦æ±‚ï¼ˆåŒæ„ç¨‹åº¦ã€è¡¥å……è¯´æ˜ã€ç«‹åœºé€‰æ‹©ç­‰ï¼‰")
    print(f"   æ•´åˆèƒ½åŠ›: å¼ºåˆ¶è¦æ±‚åˆ†æä¸é—®é¢˜å›ç­”æœ‰æœºç»“åˆ")

    print("\nğŸ¯ é¢„æœŸæ”¶æ•›æ•ˆæœ:")
    print("âœ… æ›´ç²¾å‡†çš„æ”¶æ•›åˆ¤æ–­: chairmanèƒ½åŸºäºæ·±åº¦åˆ†æè¯„ä¼°è®¨è®ºè´¨é‡")
    print("âœ… æ›´å¿«çš„æ”¶æ•›é€Ÿåº¦: ç»“æ„åŒ–åˆ†æå‡å°‘æ— æ•ˆè®¨è®º")
    print("âœ… æ›´é«˜è´¨é‡çš„ç­”æ¡ˆ: ç»¼åˆå¤šä¸ªç»´åº¦çš„æ·±åº¦åˆ†æ")
    print("âœ… æ›´æ¸…æ™°çš„åˆ†æ­§ç®¡ç†: æ˜ç¡®å†²çªæ ¹æºå’Œè§£å†³æ–¹æ¡ˆ")

if __name__ == "__main__":
    test_optimized_integration()